<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>LED QRcode ç´€éŒ„è¡¨å–®</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f8;
      padding: 20px;
      max-width: 480px;
      margin: auto;
    }
    .form-card {
      background: linear-gradient(180deg, #ffffff, #f8f9fb);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    h2 {
      text-align: center;
      color: #004080;
    }
    label {
      margin-top: 16px;
      display: block;
      font-weight: bold;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 4px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      appearance: none; /*è®“ iPhone ä¹Ÿçµ±ä¸€æ¨£å¼*/
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    /*è®“ä¸‹æ‹‰å¼é¸å–®æœ‰ç®­é ­ç¬¦è™Ÿ*/
    select{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: url('data:image/svg+xml;utf8,<svg fill="gray" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 12px center;
      background-size: 18px 18px;
      padding-right: 36px; /*é ç•™ç®­é ­ç©ºé–“*/
    }
    button {
      margin-top: 24px;
      width: 100%;
      padding: 14px;
      font-size: 16px;
      background-color: #21867a;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    button:hover {
      background-color: #1a6b62;
    }
    button:active {
      transform: scale(0.97);
    }
    /*å‡ºå…¥åº«é¸æ“‡è®Šè‰²æç¤º*/
    select#io.in {
      background-color: #eafaf1;
      border-color: #2ecc71;
    }
    select#io.out {
      background-color: #fdecea;
      border-color: #e74c3c;
    }
    /*åŠ å…¥CSS(æ§åˆ¶å¤–è§€)ï¼‹ï¼æ¡ˆç´*/
    .quantity-wrapper{
      display: flex;
      align-items: center; /*ä¿æŒå°é½Šä¸­ç·š*/
      gap: 15px; /*èˆ‡æŒ‰éˆ•çš„é–“è·*/
      margin-top: 4px; /*èˆ‡ä¸Šæ¬„é–“è·*/
    }
    .quantity-wrapper button{
      width: 45px; height: 45px;
      font-size: 28px;
      border: none;
      border-radius: 8px;
      background-color: #dce3f1;
      color: #2a4d8f;
      cursor: pointer;
      display: flex;
      justify-content: center; /*æ°´å¹³ç½®ä¸­*/
      align-items: center; /*å‚ç›´ç½®ä¸­*/
      margin-top: -3px; /*æŒ‰éˆ•å¾€ä¸Šç§»*/
    }
    .quantity-wrapper button:active {
      transform: scale(0.95);
    }
    .quantity-wrapper input.quantity-input {
      flex: 1;
      height: 45px;
      text-align: center;
      font-size: 20px;
      padding: 10px;
    }
    /*åŠ å…¥CSS(æ§åˆ¶å¤–è§€)ï¼‹ï¼æ¡ˆç´*/
    .form-header {
      background: linear-gradient(to left, #1d3557,#2a9d8f);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      text-align: center;
      margin-bottom: 0;
    }
    .form-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: bold;
      color: #90f7ec;
    }
    .form-header p {
      margin-top: 6px;
      font-size: 14px;
      color: #d0e7e5;
    }
</style>
<script>

//QRæƒæ
function startQrScanner() {
  const scannerDiv = document.getElementById("qr_scanner_area");
  const zoomControls = document.getElementById("zoom_controls");
  const zoomSlider = document.getElementById("zoom_slider");
  const zoomValue = document.getElementById("zoom_value");
  
  scannerDiv.style.display = "block";
  zoomControls.style.display = "block";

  const html5QrCode = new Html5Qrcode("qr_scanner_area");

  const config = {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    videoConstraints: {
      facingMode: "environment"
    }
  };
  html5QrCode.start(config.videoConstraints, config,
    (decodedText) => {
      //æƒææˆåŠŸå¾Œï¼Œå°‡çµæœå¡«å…¥LEDæ¢ç¢¼æ¬„ä½
      document.getElementById('ledcode_input').value = decodedText;
      //å¡«å…¥å¾Œç«‹å³åœæ­¢æƒæ
      html5QrCode.stop().then(() => {
        scannerDiv.style.display = "none";
        zoomControls.style.display = "none";
        alert("QR Code å·²æˆåŠŸæƒæï¼");
      }).catch((err) => {
        console.error("åœæ­¢æƒæå™¨å¤±æ•—ï¼š",err);
      });
    },
    (errorMessage) => {
      console.log(errorMessage);
    }
  ).then(() => {
    //æƒç„å™¨æˆåŠŸå•Ÿå‹•å¾Œï¼Œå–å¾—ç›¸æ©Ÿè»Œé“(track)
    const videoElement = html5QrCode.get === 'function' ? html5QrCode.getHtml5VideoElement() : document.querySelector('#qr_scanner_area video');
    const track = videoElement.srcObject.getVideoTracks()[0];

    if (track.getCapabilities().zoom) {
      //æª¢æŸ¥ç›¸æ©Ÿæ˜¯å¦æ”¯æ´ç¸®æ”¾åŠŸèƒ½
      const capabilities = track.getCapabilities();
      const minZoom = capabilities.zoom.min;
      const maxZoom = capabilities.zoom.max;

      zoomSlider.min = minZoom;
      zoomSlider.max = maxZoom;
      zoomSlider.value = minZoom;
      zoomValue.textContent = `${minZoom.toFixed(1)}x`;

      //ç›£è½æ»‘å‹•æ¢çš„è®ŠåŒ–
      zoomSlider.oninput = () => {
        const newZoom = parseFloat(zoomSlider.value);
        track.applyConstraints({ advanced: [{ zoom: newZoom }] })
          .then(() => {
            zoomValue.textContent = `${newZoom.toFixed(1)}x`;
          })
          .catch(err => {
            console.error("è¨­å®šç¸®æ”¾å¤±æ•—ï¼š", err);
          });
      };
    } else {
      console.log("æ­¤è£ç½®ä¸æ”¯æ´ç›¸æ©Ÿç¸®æ”¾ã€‚");
      zoomControls.style.display = "none";
    }
  }).catch((err) => {
    console.error("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š", err);
    alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç€è¦½å™¨æ¬Šé™ã€‚");
    scannerDiv.style.display = "none";
    zoomControls.style.display = "none";
  });
}

// æ–°å¢ï¼šé–å®šé€å‡ºæŒ‰éˆ•çš„å‡½æ•¸ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
function lockSubmitButton() {
  var btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerText = "é€å‡ºä¸­...";
}

// æ–°å¢ï¼šè§£é–é€å‡ºæŒ‰éˆ•çš„å‡½æ•¸
function unlockSubmitButton() {
  var btn = document.getElementById("submitBtn");
  btn.disabled = false;
  btn.innerText = "é€å‡º";
}
//è¨­å®šç•¶å¤©æ—¥æœŸ
function setToday() {
  const today = new Date();
  const year = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById("date").value = year + "/" + mm + "/" + dd;
}

// ä¿®æ”¹ï¼šæ›´æ–° toggleCustomUser å‡½æ•¸é‚è¼¯ï¼Œæ›´ç²¾ç¢ºåœ°æ§åˆ¶ name å’Œ required å±¬æ€§
function toggleCustomUser() {
  const sel = document.getElementById("user_select");
  const customBox = document.getElementById("custom_user_box");
  const customInput = document.getElementById("custom_user_input");

  if (sel.value === "å…¶ä»–") {
    customBox.style.display = "block";
    sel.name = ""; // ç§»é™¤ä¸‹æ‹‰é¸å–®çš„ name å±¬æ€§ï¼Œé€™æ¨£å®ƒçš„å€¼å°±ä¸æœƒè¢«æäº¤
    customInput.name = "operator"; // å°‡ name å±¬æ€§è³¦äºˆåˆ°è‡ªè¨‚è¼¸å…¥æ¡†ï¼Œä½¿å…¶å€¼è¢«æäº¤
    customInput.required = true; // è¨­å®šè‡ªè¨‚è¼¸å…¥æ¡†ç‚ºå¿…å¡«
  } else {
    customBox.style.display = "none";
    sel.name = "operator"; // é‡æ–°å°‡ name å±¬æ€§è³¦äºˆåˆ°ä¸‹æ‹‰é¸å–®
    customInput.name = ""; // ç§»é™¤è‡ªè¨‚è¼¸å…¥æ¡†çš„ name å±¬æ€§
    customInput.required = false; // è¨­å®šè‡ªè¨‚è¼¸å…¥æ¡†ç‚ºéå¿…å¡«
  }
}

/*åŠ å…¥JavaScript(æ§åˆ¶æŒ‰éˆ•åŠŸèƒ½)*/
document.addEventListener("DOMContentLoaded",function(){
  const decrementBtn = document.querySelector(".decrement");
  const incrementBtn = document.querySelector(".increment");
  const qtyInput = document.querySelector(".quantity-input");

  decrementBtn.addEventListener("click",function(){
    const current = parseInt(qtyInput.value) || 1;
    if (current > 1) qtyInput.value =current -1;
  });

  incrementBtn.addEventListener("click",function(){
    const current = parseInt(qtyInput.value) || 0;
    qtyInput.value = current + 1;
  });
});

window.onload = function() {
  setToday(); //è¨­å®šç‚ºç•¶å¤©æ—¥æœŸ
};

  //æäº¤è¡¨å–®
  mainForm.addEventListener("submit", function(event) {
    event.preventDefault(); 
    const formData = new FormData(mainForm);
    const submitted_vendor_name = document.getElementById("vendor_select").options[document.getElementById("vendor_select").selectedIndex].textContent;
    const submitted_wire_name = formData.get('wire_name');
    const submitted_qty = formData.get('qty');
    const submitted_action_type = formData.get('action_type');
    const submitted_note = formData.get('note');
    //å»ºç«‹ç¢ºèªè¨Šæ¯
    const confirmationMessage = `è«‹ç¢ºèªä»¥ä¸‹è³‡è¨Šæ˜¯å¦æ­£ç¢ºï¼š\n\n` +
                                `å» å•†åç¨±ï¼š${submitted_vendor_name}\n` +
                                `ç·šæåç¨±ï¼š${submitted_wire_name}\n` +
                                `æ•¸é‡ï¼š${submitted_qty} < ${submitted_action_type} > \n` +
                                `å‚™è¨»ï¼š${submitted_note || 'ç„¡'}\n\n` +
                                `ç¢ºå®šè¦é€å‡ºå—ï¼Ÿ`;
    if (!confirm(confirmationMessage)) {
      return;
    }

    lockSubmitButton(); //é–å®šé€å‡ºæŒ‰éˆ•
    
    fetch("/submit_wire", {
      method: "POST",
      body: formData,
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success") {
        return fetch(`/api/wire_stock?wire_name=${encodeURIComponent(submitted_wire_name)}`)
          .then(stockResponse => stockResponse.json()) // è§£æåº«å­˜æŸ¥è©¢çš„å›å‚³ JSON
          .then(stockData => {
            let currentStockMessage = "ç›®å‰åº«å­˜ï¼šæŸ¥è©¢å¤±æ•—"; // é è¨­è¨Šæ¯
            if (stockData.status === "success") {
              currentStockMessage = `ç›®å‰åº«å­˜ï¼š${stockData.stock} ä¸¸`; // æˆåŠŸæŸ¥è©¢åˆ°åº«å­˜
            } else {
              currentStockMessage = `ç›®å‰åº«å­˜ï¼š${stockData.message || "æŸ¥è©¢å¤±æ•—"}`; // æŸ¥è©¢åº«å­˜å¤±æ•—
            }
        submitResultDiv.style.display = "block"; // é¡¯ç¤ºçµæœå€å¡Š
        submitResultDiv.style.borderColor = "#2ecc71"; // è¨­å®šé‚Šæ¡†é¡è‰² (æˆåŠŸ)
        //submitResultDiv.style.backgroundColor = "#eafaf1"; // è¨­å®šèƒŒæ™¯é¡è‰² (æˆåŠŸ)
        submitResultDiv.style.color = "#21867a"; // è¨­å®šæ–‡å­—é¡è‰² (æˆåŠŸ)
        submitResultDiv.innerHTML = `
                <p><strong>ç·šæ:</strong> ${submitted_wire_name}</p>
                <p><strong>æ•¸é‡:</strong> ${submitted_qty} < ${submitted_action_type} ></p>
                <p><strong>å‚™è¨»:</strong> ${submitted_note || 'ç„¡'}</p>
                <p><strong>${currentStockMessage}</strong></p>
            `;        
        mainForm.reset(); // æ¸…ç©ºè¡¨å–®æ‰€æœ‰æ¬„ä½
        setToday(); 
        document.getElementById("vendor_name_hidden").value = ""; // æ¸…ç©ºéš±è—çš„å» å•†åç¨±
        document.getElementById("wire_code_hidden").value = ""; // æ¸…ç©ºéš±è—çš„ç·šæä»£ç¢¼
        stockDisplay.innerHTML = ""; // æ¸…ç©ºåº«å­˜é¡¯ç¤º
        document.getElementById("custom_user_box").style.display = "none"; // éš±è—è‡ªè¨‚é ˜æ–™äººå“¡è¼¸å…¥æ¡†
        document.getElementById("user_select").name = "operator"; // é‡è¨­é ˜æ–™äººå“¡ä¸‹æ‹‰é¸å–®çš„ name
        document.getElementById("custom_user_input").name = ""; // æ¸…ç©ºè‡ªè¨‚é ˜æ–™äººå“¡è¼¸å…¥æ¡†çš„ name
        document.getElementById("custom_user_input").required = false; // è¨­å®šè‡ªè¨‚è¼¸å…¥æ¡†ç‚ºéå¿…å¡«
        });
      } else {
        submitResultDiv.style.display = "block"; // é¡¯ç¤ºçµæœå€å¡Š
        submitResultDiv.style.borderColor = "#e74c3c"; // è¨­å®šé‚Šæ¡†é¡è‰² (éŒ¯èª¤)
        submitResultDiv.style.backgroundColor = "#fdecea"; // è¨­å®šèƒŒæ™¯é¡è‰² (éŒ¯èª¤)
        submitResultDiv.style.color = "#c0392b"; // è¨­å®šæ–‡å­—é¡è‰² (éŒ¯èª¤)
        submitResultDiv.innerHTML = `âŒ éŒ¯èª¤ï¼š${data.message}`; // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      }
    })
    .catch(error => {
      console.error("éŒ¯èª¤:", error);
      submitResultDiv.style.display = "block";
      submitResultDiv.style.borderColor = "#e74c3c";
      submitResultDiv.style.backgroundColor = "#fdecea";
      submitResultDiv.style.color = "#c0392b";
      submitResultDiv.innerHTML = `âŒ é€å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
    })
    .finally(() => {
      unlockSubmitButton(); // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½è§£é–æŒ‰éˆ•
    });
  });


</script>
</head>
<body>
<div class="form-header">
    <h2>ç‘é‘«é›»å­ç§‘æŠ€æœ‰é™å…¬å¸</h2>
    <p>ğŸ“‹ LED QR code ç´€éŒ„è¡¨å–®</p>
</div>
<div class="form-card">
<form id="mainForm" action="/submit_wire" method="POST">
<label>ğŸ“† æ—¥æœŸ</label>
<input id="date" name="date" readonly="readonly" style="background-color: #f0f0f0; color: #666;" type="text"/>
<label>LED æ¢ç¢¼å…§å®¹</label>
<input type="text" name="ledcode" id="ledcode_input" required>
<button type="button" onclick="startQrScanner()">æƒæ QR Code</button> 
    
<div id="zoom_controls" style="display:none; text-align: center; margin-top: 10px;">
  <label for="zoom_slider">ç›¸æ©Ÿç¸®æ”¾æ¯”ä¾‹:</label>
  <input type="range" id="zoom_slider" min="1" max="10" step="0.1" value="1">
  <span id="zoom_value">1x</span>
</div>
<div id="qr_scanner_area"></div>

<label>å·¥å–®è™Ÿç¢¼ï¼ˆåƒ…é™æ•¸å­—èˆ‡ç¬¦è™Ÿï¼‰</label>
<input type="text" name="quantity" inputmode="text" pattern="[0-9\-\_\#\*]+" required>

<input type="hidden" name="wire_code" id="wire_code_hidden"> <div id="stock_display" style="margin-top: 8px; font-size: 14px; color: #2a4d8f;"></div>
<label>æ•¸é‡</label>
<div class="quantity-wrapper">
  <button type="button" class="decrement">-</button>
  <input inputmode="numeric" min="1" name="qty" required type="number" class="quantity-input" placeholder="è«‹è¼¸å…¥æ•¸é‡"/>
  <button type="button" class="increment">+</button>
</div>
<label>ğŸ‘¤ æ“ä½œäººå“¡</label>
<select id="user_select" name="operator" onchange="toggleCustomUser()" required="">
<option value="">è«‹é¸æ“‡æ“ä½œäººå“¡</option>
<option value="050-é»ƒæ¹˜å©·">050-é»ƒæ¹˜å©·</option>
<option value="053-é˜®ç‰èŠ">053-é˜®ç‰èŠ</option>
<option value="074-ç”°ä¿é§¿">074-ç”°ä¿é§¿</option>
<option value="å…¶ä»–">å…¶ä»–</option>
</select>
<div id="custom_user_box" style="display:none; margin-top:8px;">
<input id="custom_user_input" oninput="updateUserValue()" placeholder="è«‹è¼¸å…¥å§“å" type="text"/>
</div>
<label>å‚™è¨»</label>
<textarea name="note" placeholder="å…¶ä»–è£œå……èªªæ˜ï¼ˆå¯é¸å¡«ï¼‰" rows="2"></textarea>
<button id="submitBtn" type="submit">é€å‡º</button>
</form>
<div id="submit_result" style="display: none; margin-top: 20px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; padding: 12px; font-size: 15px;"></div>
</div>
</body>
</html>