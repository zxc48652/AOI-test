<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>LED QRcode 紀錄表單</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f8;
      padding: 20px;
      max-width: 480px;
      margin: auto;
    }
    .form-card {
      background: linear-gradient(180deg, #ffffff, #f8f9fb);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    h2 {
      text-align: center;
      color: #004080;
    }
    label {
      margin-top: 16px;
      display: block;
      font-weight: bold;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 4px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      appearance: none; /*讓 iPhone 也統一樣式*/
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    /*讓下拉式選單有箭頭符號*/
    select{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: url('data:image/svg+xml;utf8,<svg fill="gray" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 12px center;
      background-size: 18px 18px;
      padding-right: 36px; /*預留箭頭空間*/
    }
    button {
      margin-top: 24px;
      width: 100%;
      padding: 14px;
      font-size: 16px;
      background-color: #21867a;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    button:hover {
      background-color: #1a6b62;
    }
    button:active {
      transform: scale(0.97);
    }
    /*加入CSS(控制外觀)＋－案紐*/
    .quantity-wrapper{
      display: flex;
      align-items: center; /*保持對齊中線*/
      gap: 15px; /*與按鈕的間距*/
      margin-top: 4px; /*與上欄間距*/
    }
    .quantity-wrapper button{
      width: 45px; height: 45px;
      font-size: 28px;
      border: none;
      border-radius: 8px;
      background-color: #dce3f1;
      color: #2a4d8f;
      cursor: pointer;
      display: flex;
      justify-content: center; /*水平置中*/
      align-items: center; /*垂直置中*/
      margin-top: -3px; /*按鈕往上移*/
    }
    .quantity-wrapper button:active {
      transform: scale(0.95);
    }
    .quantity-wrapper input.quantity-input {
      flex: 1;
      height: 45px;
      text-align: center;
      font-size: 20px;
      padding: 10px;
    }
    /*加入CSS(控制外觀)＋－案紐*/
    .form-header {
      background: linear-gradient(to left, #1d3557,#2a9d8f);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      text-align: center;
      margin-bottom: 0;
    }
    .form-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: bold;
      color: #90f7ec;
    }
    .form-header p {
      margin-top: 6px;
      font-size: 14px;
      color: #d0e7e5;
    }
  /*修改輸入text的欄位大小*/
  textarea[name="ledcode"] {
    white-space: normal;
    word-break: break-all;
    overflow-wrap: break-word;
    height: auto;
    padding-bottom: 12px;
  }
</style>
<script>

//QR掃描
function startQrScanner() {
  const scannerDiv = document.getElementById("qr_scanner_area");
  const zoomControls = document.getElementById("zoom_controls");
  const zoomSlider = document.getElementById("zoom_slider");
  const zoomValue = document.getElementById("zoom_value");
  
  scannerDiv.style.display = "block";
  zoomControls.style.display = "block";

  const html5QrCode = new Html5Qrcode("qr_scanner_area");

  const config = {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    videoConstraints: {
      facingMode: "environment"
    }
  };
  html5QrCode.start(config.videoConstraints, config,
    (decodedText) => {
      //掃描成功後，將結果填入LED條碼欄位
      document.getElementById('ledcode_input').value = decodedText;
      //填入後立即停止掃描
      html5QrCode.stop().then(() => {
        scannerDiv.style.display = "none";
        zoomControls.style.display = "none";
        alert("QR Code 已成功掃描！");
      }).catch((err) => {
        console.error("停止掃描器失敗：",err);
      });
    },
    (errorMessage) => {
      console.log(errorMessage);
    }
  ).then(() => {
    //掃瞄器成功啟動後，取得相機軌道(track)
    const videoElement = html5QrCode.get === 'function' ? html5QrCode.getHtml5VideoElement() : document.querySelector('#qr_scanner_area video');
    const track = videoElement.srcObject.getVideoTracks()[0];

    if (track.getCapabilities().zoom) {
      //檢查相機是否支援縮放功能
      const capabilities = track.getCapabilities();
      const minZoom = capabilities.zoom.min;
      const maxZoom = capabilities.zoom.max;

      zoomSlider.min = minZoom;
      zoomSlider.max = maxZoom;
      zoomSlider.value = minZoom;
      zoomValue.textContent = `${minZoom.toFixed(1)}x`;

      //監聽滑動條的變化
      zoomSlider.oninput = () => {
        const newZoom = parseFloat(zoomSlider.value);
        track.applyConstraints({ advanced: [{ zoom: newZoom }] })
          .then(() => {
            zoomValue.textContent = `${newZoom.toFixed(1)}x`;
          })
          .catch(err => {
            console.error("設定縮放失敗：", err);
          });
      };
    } else {
      console.log("此裝置不支援相機縮放。");
      zoomControls.style.display = "none";
    }
  }).catch((err) => {
    console.error("無法啟動相機：", err);
    alert("無法啟動相機，請檢查您的瀏覽器權限。");
    scannerDiv.style.display = "none";
    zoomControls.style.display = "none";
  });
}

//鎖定送出按鈕的函數，防止重複點擊
function lockSubmitButton() {
  var btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerText = "送出中...";
}
// 解鎖送出按鈕的函數
function unlockSubmitButton() {
  var btn = document.getElementById("submitBtn");
  btn.disabled = false;
  btn.innerText = "送出";
}
//設定當天日期
function setToday() {
  const today = new Date();
  const year = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById("date").value = year + "/" + mm + "/" + dd;
}
//設定載入為當天日期
window.onload = function() {
  setToday(); 
};

// 修改：更新 toggleCustomUser 函數邏輯，更精確地控制 name 和 required 屬性
function toggleCustomUser() {
  const sel = document.getElementById("user_select");
  const customBox = document.getElementById("custom_user_box");
  const customInput = document.getElementById("custom_user_input");

  if (sel.value === "其他") {
    customBox.style.display = "block";
    sel.name = ""; // 移除下拉選單的 name 屬性，這樣它的值就不會被提交
    customInput.name = "operator"; // 將 name 屬性賦予到自訂輸入框，使其值被提交
    customInput.required = true; // 設定自訂輸入框為必填
  } else {
    customBox.style.display = "none";
    sel.name = "operator"; // 重新將 name 屬性賦予到下拉選單
    customInput.name = ""; // 移除自訂輸入框的 name 屬性
    customInput.required = false; // 設定自訂輸入框為非必填
  }
}

/*加減功能按鈕*/
document.addEventListener("DOMContentLoaded",function(){
  const decrementBtn = document.querySelector(".decrement");
  const incrementBtn = document.querySelector(".increment");
  const qtyInput = document.querySelector(".quantity-input");
  const form = document.getElementById("mainForm");

  decrementBtn.addEventListener("click",function(){
    const current = parseInt(qtyInput.value) || 1;
    if (current > 1) qtyInput.value =current -1;
  });

  incrementBtn.addEventListener("click",function(){
    const current = parseInt(qtyInput.value) || 0;
    qtyInput.value = current + 1;
  });

  form.addEventListener("submit", function(event) { //處理表單送出事件
                event.preventDefault(); 
                submitFormData();
  });
});

//送出表單功能
function submitFormData() {
  lockSubmitButton(); //鎖定按鈕防止重複提交
  
  const form = document.getElementById("mainForm");
  const formData = new FormData(form); //獲取表單所有數據
  //獲取表單數據並將其轉換為 JSON 物件
  const data = {};
  for (let [key, value] of formData.entries()) {
    data[key] = value;
  }
  fetch('http://45.63.120.104:5006/submit_QRcode', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json', //告訴伺服器傳送的是 JSON
    },
    body: JSON.stringify(data), //將 JavaScript 物件轉換為 JSON 字串
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => { throw err; });
    }
    return response.json();
  })
  .then(result => {
    //成功處理
    const submitResultDiv = document.getElementById("submit_result");
    submitResultDiv.style.display = "block";
    submitResultDiv.style.backgroundColor = "#e0ffe0"; // 綠色背景表示成功
    submitResultDiv.style.borderColor = "#a3daa3";
    submitResultDiv.innerHTML = `<p style="color: #006400;">✔ ${result.message}<br><strong>工單號碼:</strong> ${data.work_id}<br><strong>LED 條碼:</strong> ${data.ledcode}</p>`; // 顯示成功訊息
    //清空和重設欄位
    document.getElementById('ledcode_input').value = ''; //清除LED條碼內容
    document.querySelector('.quantity-input').value = '1'; //重設 LED 捲數
  })
  .catch(error => {
    // 處理錯誤
    const submitResultDiv = document.getElementById("submit_result");
    submitResultDiv.style.display = "block";
    submitResultDiv.style.backgroundColor = "#ffe0e0"; // 淺紅色背景表示錯誤
    submitResultDiv.style.borderColor = "#f5b7b7";

    let errorMessage = "發生了未預期的錯誤。";
    if (error.message) {
      errorMessage = error.message;
    } else if (typeof error === 'object' && error !== null) {
      errorMessage = Object.values(error).join(', ');
    }
    submitResultDiv.innerHTML = `<p style="color: #8b0000;"><strong>錯誤:</strong> ${errorMessage}</p>`;
    console.error('表單提交錯誤:', error);
  })
  .finally(() => {
    unlockSubmitButton(); //無論成功與否，都解鎖按鈕
  });
}

</script>
</head>
<body>
<div class="form-header">
    <h2>瑞鑫電子科技有限公司</h2>
    <p>📋 LED QR code 紀錄表單</p>
</div>
<div class="form-card">
<form id="mainForm">
<label>📆 日期</label>
<input id="date" name="date" readonly="readonly" style="background-color: #f0f0f0; color: #666;" type="text"/>

<button type="button" onclick="startQrScanner()">掃描 QR Code</button> 
    
<div id="zoom_controls" style="display:none; text-align: center; margin-top: 10px;">
  <label for="zoom_slider">相機縮放比例:</label>
  <input type="range" id="zoom_slider" min="1" max="10" step="0.1" value="1">
  <span id="zoom_value">1x</span>
</div>
<div id="qr_scanner_area"></div>

<label>LED 條碼內容（掃碼輸入）</label>
<textarea name="ledcode" id="ledcode_input" required></textarea>

<label>工單號碼（僅限數字與符號）</label>
<input type="text" name="work_id" inputmode="text" pattern="[0-9\-\_\#\*]+" required>

<input type="hidden" name="wire_code" id="wire_code_hidden"> <div id="stock_display" style="margin-top: 8px; font-size: 14px; color: #2a4d8f;"></div>
<label>LED 捲數</label>
<div class="quantity-wrapper">
  <button type="button" class="decrement">-</button>
  <input inputmode="numeric" min="1" name="qty" required type="number" class="quantity-input" placeholder="請輸入數量" value="1"/>
  <button type="button" class="increment">+</button>
</div>
<label>👤 操作人員</label>
<select id="user_select" name="operator" onchange="toggleCustomUser()" required="">
<option value="">請選擇操作人員</option>
<option value="050-黃湘婷">050-黃湘婷</option>
<option value="053-阮玉芝">053-阮玉芝</option>
<option value="074-田俞駿">074-田俞駿</option>
<option value="其他">其他</option>
</select>
<div id="custom_user_box" style="display:none; margin-top:8px;">
<input id="custom_user_input" oninput="updateUserValue()" placeholder="請輸入姓名" type="text"/>
</div>
<label>備註</label>
<textarea name="note" placeholder="其他補充說明（可選填）" rows="2"></textarea>
<button id="submitBtn" type="submit">送出</button>
</form>
<div id="submit_result" style="display: none; margin-top: 20px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; padding: 12px; font-size: 15px;"></div>
</div>
</body>
</html>