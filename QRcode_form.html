<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>LED QRcode 紀錄表單</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f8;
      padding: 20px;
      max-width: 480px;
      margin: auto;
    }
    .form-card {
      background: linear-gradient(180deg, #ffffff, #f8f9fb);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    h2 {
      text-align: center;
      color: #004080;
    }
    label {
      margin-top: 16px;
      display: block;
      font-weight: bold;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 4px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      appearance: none; /*讓 iPhone 也統一樣式*/
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    /*讓下拉式選單有箭頭符號*/
    select{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: url('data:image/svg+xml;utf8,<svg fill="gray" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 12px center;
      background-size: 18px 18px;
      padding-right: 36px; /*預留箭頭空間*/
    }
    button {
      margin-top: 24px;
      width: 100%;
      padding: 14px;
      font-size: 16px;
      background-color: #21867a;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    button:hover {
      background-color: #1a6b62;
    }
    button:active {
      transform: scale(0.97);
    }
    /*出入庫選擇變色提示*/
    select#io.in {
      background-color: #eafaf1;
      border-color: #2ecc71;
    }
    select#io.out {
      background-color: #fdecea;
      border-color: #e74c3c;
    }
    /*加入CSS(控制外觀)＋－案紐*/
    .quantity-wrapper{
      display: flex;
      align-items: center; /*保持對齊中線*/
      gap: 15px; /*與按鈕的間距*/
      margin-top: 4px; /*與上欄間距*/
    }
    .quantity-wrapper button{
      width: 45px; height: 45px;
      font-size: 28px;
      border: none;
      border-radius: 8px;
      background-color: #dce3f1;
      color: #2a4d8f;
      cursor: pointer;
      display: flex;
      justify-content: center; /*水平置中*/
      align-items: center; /*垂直置中*/
      margin-top: -3px; /*按鈕往上移*/
    }
    .quantity-wrapper button:active {
      transform: scale(0.95);
    }
    .quantity-wrapper input.quantity-input {
      flex: 1;
      height: 45px;
      text-align: center;
      font-size: 20px;
      padding: 10px;
    }
    /*加入CSS(控制外觀)＋－案紐*/
    .form-header {
      background: linear-gradient(to left, #1d3557,#2a9d8f);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      text-align: center;
      margin-bottom: 0;
    }
    .form-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: bold;
      color: #90f7ec;
    }
    .form-header p {
      margin-top: 6px;
      font-size: 14px;
      color: #d0e7e5;
    }
</style>
<script>

//QR掃描
function startQrScanner() {
  const scannerDiv = document.getElementById("qr_scanner_area");
  const zoomControls = document.getElementById("zoom_controls");
  const zoomSlider = document.getElementById("zoom_slider");
  const zoomValue = document.getElementById("zoom_value");
  
  scannerDiv.style.display = "block";
  zoomControls.style.display = "block";

  const html5QrCode = new Html5Qrcode("qr_scanner_area");

  const config = {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    videoConstraints: {
      facingMode: "environment"
    }
  };
  html5QrCode.start(config.videoConstraints, config,
    (decodedText) => {
      //掃描成功後，將結果填入LED條碼欄位
      document.getElementById('ledcode_input').value = decodedText;
      //填入後立即停止掃描
      html5QrCode.stop().then(() => {
        scannerDiv.style.display = "none";
        zoomControls.style.display = "none";
        alert("QR Code 已成功掃描！");
      }).catch((err) => {
        console.error("停止掃描器失敗：",err);
      });
    },
    (errorMessage) => {
      console.log(errorMessage);
    }
  ).then(() => {
    //掃瞄器成功啟動後，取得相機軌道(track)
    const videoElement = html5QrCode.get === 'function' ? html5QrCode.getHtml5VideoElement() : document.querySelector('#qr_scanner_area video');
    const track = videoElement.srcObject.getVideoTracks()[0];

    if (track.getCapabilities().zoom) {
      //檢查相機是否支援縮放功能
      const capabilities = track.getCapabilities();
      const minZoom = capabilities.zoom.min;
      const maxZoom = capabilities.zoom.max;

      zoomSlider.min = minZoom;
      zoomSlider.max = maxZoom;
      zoomSlider.value = minZoom;
      zoomValue.textContent = `${minZoom.toFixed(1)}x`;

      //監聽滑動條的變化
      zoomSlider.oninput = () => {
        const newZoom = parseFloat(zoomSlider.value);
        track.applyConstraints({ advanced: [{ zoom: newZoom }] })
          .then(() => {
            zoomValue.textContent = `${newZoom.toFixed(1)}x`;
          })
          .catch(err => {
            console.error("設定縮放失敗：", err);
          });
      };
    } else {
      console.log("此裝置不支援相機縮放。");
      zoomControls.style.display = "none";
    }
  }).catch((err) => {
    console.error("無法啟動相機：", err);
    alert("無法啟動相機，請檢查您的瀏覽器權限。");
    scannerDiv.style.display = "none";
    zoomControls.style.display = "none";
  });
}

// 新增：鎖定送出按鈕的函數，防止重複點擊
function lockSubmitButton() {
  var btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerText = "送出中...";
}

// 新增：解鎖送出按鈕的函數
function unlockSubmitButton() {
  var btn = document.getElementById("submitBtn");
  btn.disabled = false;
  btn.innerText = "送出";
}
//設定當天日期
function setToday() {
  const today = new Date();
  const year = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById("date").value = year + "/" + mm + "/" + dd;
}

// 修改：更新 toggleCustomUser 函數邏輯，更精確地控制 name 和 required 屬性
function toggleCustomUser() {
  const sel = document.getElementById("user_select");
  const customBox = document.getElementById("custom_user_box");
  const customInput = document.getElementById("custom_user_input");

  if (sel.value === "其他") {
    customBox.style.display = "block";
    sel.name = ""; // 移除下拉選單的 name 屬性，這樣它的值就不會被提交
    customInput.name = "operator"; // 將 name 屬性賦予到自訂輸入框，使其值被提交
    customInput.required = true; // 設定自訂輸入框為必填
  } else {
    customBox.style.display = "none";
    sel.name = "operator"; // 重新將 name 屬性賦予到下拉選單
    customInput.name = ""; // 移除自訂輸入框的 name 屬性
    customInput.required = false; // 設定自訂輸入框為非必填
  }
}

/*加入JavaScript(控制按鈕功能)*/
document.addEventListener("DOMContentLoaded",function(){
  const decrementBtn = document.querySelector(".decrement");
  const incrementBtn = document.querySelector(".increment");
  const qtyInput = document.querySelector(".quantity-input");

  decrementBtn.addEventListener("click",function(){
    const current = parseInt(qtyInput.value) || 1;
    if (current > 1) qtyInput.value =current -1;
  });

  incrementBtn.addEventListener("click",function(){
    const current = parseInt(qtyInput.value) || 0;
    qtyInput.value = current + 1;
  });
});

window.onload = function() {
  setToday(); //設定為當天日期
};

  //提交表單
  mainForm.addEventListener("submit", function(event) {
    event.preventDefault(); 
    const formData = new FormData(mainForm);
    const submitted_vendor_name = document.getElementById("vendor_select").options[document.getElementById("vendor_select").selectedIndex].textContent;
    const submitted_wire_name = formData.get('wire_name');
    const submitted_qty = formData.get('qty');
    const submitted_action_type = formData.get('action_type');
    const submitted_note = formData.get('note');
    //建立確認訊息
    const confirmationMessage = `請確認以下資訊是否正確：\n\n` +
                                `廠商名稱：${submitted_vendor_name}\n` +
                                `線材名稱：${submitted_wire_name}\n` +
                                `數量：${submitted_qty} < ${submitted_action_type} > \n` +
                                `備註：${submitted_note || '無'}\n\n` +
                                `確定要送出嗎？`;
    if (!confirm(confirmationMessage)) {
      return;
    }

    lockSubmitButton(); //鎖定送出按鈕
    
    fetch("/submit_wire", {
      method: "POST",
      body: formData,
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success") {
        return fetch(`/api/wire_stock?wire_name=${encodeURIComponent(submitted_wire_name)}`)
          .then(stockResponse => stockResponse.json()) // 解析庫存查詢的回傳 JSON
          .then(stockData => {
            let currentStockMessage = "目前庫存：查詢失敗"; // 預設訊息
            if (stockData.status === "success") {
              currentStockMessage = `目前庫存：${stockData.stock} 丸`; // 成功查詢到庫存
            } else {
              currentStockMessage = `目前庫存：${stockData.message || "查詢失敗"}`; // 查詢庫存失敗
            }
        submitResultDiv.style.display = "block"; // 顯示結果區塊
        submitResultDiv.style.borderColor = "#2ecc71"; // 設定邊框顏色 (成功)
        //submitResultDiv.style.backgroundColor = "#eafaf1"; // 設定背景顏色 (成功)
        submitResultDiv.style.color = "#21867a"; // 設定文字顏色 (成功)
        submitResultDiv.innerHTML = `
                <p><strong>線材:</strong> ${submitted_wire_name}</p>
                <p><strong>數量:</strong> ${submitted_qty} < ${submitted_action_type} ></p>
                <p><strong>備註:</strong> ${submitted_note || '無'}</p>
                <p><strong>${currentStockMessage}</strong></p>
            `;        
        mainForm.reset(); // 清空表單所有欄位
        setToday(); 
        document.getElementById("vendor_name_hidden").value = ""; // 清空隱藏的廠商名稱
        document.getElementById("wire_code_hidden").value = ""; // 清空隱藏的線材代碼
        stockDisplay.innerHTML = ""; // 清空庫存顯示
        document.getElementById("custom_user_box").style.display = "none"; // 隱藏自訂領料人員輸入框
        document.getElementById("user_select").name = "operator"; // 重設領料人員下拉選單的 name
        document.getElementById("custom_user_input").name = ""; // 清空自訂領料人員輸入框的 name
        document.getElementById("custom_user_input").required = false; // 設定自訂輸入框為非必填
        });
      } else {
        submitResultDiv.style.display = "block"; // 顯示結果區塊
        submitResultDiv.style.borderColor = "#e74c3c"; // 設定邊框顏色 (錯誤)
        submitResultDiv.style.backgroundColor = "#fdecea"; // 設定背景顏色 (錯誤)
        submitResultDiv.style.color = "#c0392b"; // 設定文字顏色 (錯誤)
        submitResultDiv.innerHTML = `❌ 錯誤：${data.message}`; // 顯示錯誤訊息
      }
    })
    .catch(error => {
      console.error("錯誤:", error);
      submitResultDiv.style.display = "block";
      submitResultDiv.style.borderColor = "#e74c3c";
      submitResultDiv.style.backgroundColor = "#fdecea";
      submitResultDiv.style.color = "#c0392b";
      submitResultDiv.innerHTML = `❌ 送出時發生錯誤：${error.message}`;
    })
    .finally(() => {
      unlockSubmitButton(); // 無論成功或失敗，都解鎖按鈕
    });
  });


</script>
</head>
<body>
<div class="form-header">
    <h2>瑞鑫電子科技有限公司</h2>
    <p>📋 LED QR code 紀錄表單</p>
</div>
<div class="form-card">
<form id="mainForm" action="/submit_wire" method="POST">
<label>📆 日期</label>
<input id="date" name="date" readonly="readonly" style="background-color: #f0f0f0; color: #666;" type="text"/>
<label>LED 條碼內容</label>
<input type="text" name="ledcode" id="ledcode_input" required>
<button type="button" onclick="startQrScanner()">掃描 QR Code</button> 
    
<div id="zoom_controls" style="display:none; text-align: center; margin-top: 10px;">
  <label for="zoom_slider">相機縮放比例:</label>
  <input type="range" id="zoom_slider" min="1" max="10" step="0.1" value="1">
  <span id="zoom_value">1x</span>
</div>
<div id="qr_scanner_area"></div>

<label>工單號碼（僅限數字與符號）</label>
<input type="text" name="quantity" inputmode="text" pattern="[0-9\-\_\#\*]+" required>

<input type="hidden" name="wire_code" id="wire_code_hidden"> <div id="stock_display" style="margin-top: 8px; font-size: 14px; color: #2a4d8f;"></div>
<label>數量</label>
<div class="quantity-wrapper">
  <button type="button" class="decrement">-</button>
  <input inputmode="numeric" min="1" name="qty" required type="number" class="quantity-input" placeholder="請輸入數量"/>
  <button type="button" class="increment">+</button>
</div>
<label>👤 操作人員</label>
<select id="user_select" name="operator" onchange="toggleCustomUser()" required="">
<option value="">請選擇操作人員</option>
<option value="050-黃湘婷">050-黃湘婷</option>
<option value="053-阮玉芝">053-阮玉芝</option>
<option value="074-田俞駿">074-田俞駿</option>
<option value="其他">其他</option>
</select>
<div id="custom_user_box" style="display:none; margin-top:8px;">
<input id="custom_user_input" oninput="updateUserValue()" placeholder="請輸入姓名" type="text"/>
</div>
<label>備註</label>
<textarea name="note" placeholder="其他補充說明（可選填）" rows="2"></textarea>
<button id="submitBtn" type="submit">送出</button>
</form>
<div id="submit_result" style="display: none; margin-top: 20px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; padding: 12px; font-size: 15px;"></div>
</div>
</body>
</html>